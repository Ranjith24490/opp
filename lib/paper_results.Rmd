---
title: "A large-scale analysis of racial disparities in police stops across the
United States"
classoption: landscape
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
pfs <- read_rds(here::here("results", "prima_facie_stats.rds"))
vod <- read_rds(here::here("results", "veil_of_darkness.rds"))
disp <- read_rds(here::here("results", "disparity.rds"))
mj <- read_rds(here::here("results", "marijuana_legalization_analysis.rds"))
```


\section{Basic Numbers}


We have collected and released a dataset of 
`r comma_num(pfs$counts$collected$n_stops)` traffic stops carried out by 
`r pfs$counts$collected$n_states` state patrol agencies and 
`r pfs$counts$collected$n_cities` municipal police departments.

We analyzed a unique dataset detailing 
`r comma_num(pfs$counts$analyzed$n_stops)` traffic stops carried out by 
`r pfs$counts$analyzed$n_states` state patrol agencies and 
`r pfs$counts$analyzed$n_cities` municipal police departments.


\section{Prima Facie Stats}


```{r stop_rates}
pfs$rates$stop %>%
  mutate(agency = if_else(city == "Statewide", "state patrol", "municipal pd")) %>% 
  group_by(agency, subject_race) %>%
  summarize(average_annual_stop_rate = mean(annual_stop_rate)) %>%
  kable()
```

Number of state patrols with data for search analysis: 
`r pfs$rates$search %>% filter(city == "Statewide") %>% select(state) %>% n_distinct`
Number of city departments with data for search analysis: 
`r pfs$rates$search %>% filter(city != "Statewide") %>% select(state, city) %>% n_distinct`

```{r search_rates}
pfs$rates$search %>% 
  mutate(agency = if_else(city == "Statewide", "state patrol", "municipal pd")) %>% 
  group_by(agency, subject_race) %>%
  summarize(average_search_rate = mean(search_rate)) %>%
  kable()
```


\newpage

\section{Veil of Darkness}

```{r veil_of_darkness-plot-630, fig.height=6, fig.width=9}
vod$full$plots$states$TX$`6:30pm`
```

\newpage

```{r veil_of_darkness-plot-645, fig.height=6, fig.width=9}
vod$full$plots$states$TX$`6:45pm`
```

\newpage

```{r veil_of_darkness-plot-700, fig.height=6, fig.width=9}
vod$full$plots$states$TX$`7:00pm`
```

\newpage

```{r veil_of_darkness-plot-715, fig.height=6, fig.width=9}
vod$full$plots$states$TX$`7:15pm`
```

\newpage

```{r veil_of_darkness-plot-730, fig.height=6, fig.width=9}
vod$full$plots$states$TX$`7:30pm`
```

\newpage

```{r veil_of_darkness-plot-745, fig.height=6, fig.width=9}
vod$full$plots$states$TX$`7:45pm`
```

\subsection{Main model results}

```{r veil_of_darkness-main_mod}
vod$dst %>% 
  filter(spline_degree == 6, agency_control, interact_time_loc) %>% 
  kable()
```

\newpage
\subsection{Model results for the appendix/footnote reference}

Number of robustness check models with results not statistically significant: 
`r vod$dst %>% filter(is_dark + 1.96*std_error >= 0) %>% nrow`

```{r veil_of_darkness-appendix_mods}
bind_rows(
  vod$dst %>%
    mutate(model = "DST"),
  vod$full$coefficients %>%
    mutate(model = "Full year")
) %>%
  select(model, agency, is_dark, std_error, everything()) %>%
  kable()
```

\newpage

\section{Search Disparity Analysis}

State patrol agencies analyzed: 
`r disp$state$outcome$results$hit_rates$geography %>% unique()`
Number of state patrol searches: 
`r disp$state$outcome$results$hit_rates$n_search_conducted %>% sum()`
Municipal departments analyzed:
`r disp$city$outcome$results$hit_rates$geography %>% unique()`
Number of municipal pd searches: 
`r disp$city$outcome$results$hit_rates$n_search_conducted %>% sum()`

\subsection{Outcome Test}


```{r disparity-hit_rates-tables}
kable(disp$city$outcome$results$aggregate_hit_rates)
kable(disp$state$outcome$results$aggregate_hit_rates)
```

\newpage

```{r disparity-city-hit_rates-plot, fig.height=6, fig.width=10}
disp$city$outcome$plots$aggregate + theme(legend.position = "none")
```

\newpage

```{r disparity-state-hit_rates-plot, fig.height=6, fig.width=10}
disp$state$outcome$plots$aggregate + theme(legend.position = "none")
```

\newpage

\subsection{Threshold test results}

```{r disparity-thresholds-tables}
kable(disp$city$threshold$results$aggregate_thresholds)
kable(disp$state$threshold$results$aggregate_thresholds)
```

\newpage

```{r disparity-city-thresholds-plot, fig.height=5, fig.width=10}
disp$city$threshold$plots$aggregate + theme(legend.position = "none")
```

\newpage

```{r disparity-state-thresholds-plot, fig.height=5, fig.width=10}
disp$state$threshold$plots$aggregate + theme(legend.position = "none")
```

\newpage

```{r disparity-city-ppc-search, fig.height=5, fig.width=8}
disp$city$threshold$ppc$search_rate
```

\newpage

```{r disparity-city-ppc-hit, fig.height=5, fig.width=8}
disp$city$threshold$ppc$hit_rate
```

\newpage

```{r disparity-state-ppc-search, fig.height=5, fig.width=8}
disp$state$threshold$ppc$search_rate
```

\newpage

```{r disparity-state-ppc-hit, fig.height=5, fig.width=8}
disp$state$threshold$ppc$hit_rate
```

\newpage


\section{Marijuana Legalization Analysis}


```{r mj_table}
kable(mj$tables$search_rate_difference_in_difference_coefficients)
```

\newpage

```{r mj_treatment_search_rates_plot, fig.height=5, fig.width=10}
mj$plots$treatment_search_rates + theme(
  legend.position = c(0.88, 0.80),
  axis.title.y = element_text(size = 12)
)
```

\newpage

```{r mj_treatment_misdemeanor_rates_plot, fig.height=5, fig.width=10}
mj$plots$treatment_misdemeanor_rates + theme(
  legend.position = c(0.88, 0.80),
  axis.title.y = element_text(size = 12)
)
```

\newpage

```{r mj_inferred_threshold_plot, fig.height=5, fig.width=10}
mj$plots$inferred_threshold_changes
```

\newpage

```{r save_mj_control_search_rates, fig.height=5, fig.width=10}
mj$plots$control_search_rates
```
